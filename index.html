<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>P2P Chat</title>
  <style>
    body { font-family: sans-serif; }
    #messages { border: 1px solid #ccc; height: 200px; overflow-y: auto; padding: 5px; }
    #input { width: 80%; }
    #send { width: 18%; }
  </style>
</head>
<body>
  <h1>P2P Chat</h1>
  <div id="messages"></div>
  <input id="input" placeholder="Type a message" />
  <button id="send">Send</button>

<script>
const pc = new RTCPeerConnection({
  iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
});

let channel = pc.createDataChannel("chat");
channel.onmessage = e => addMessage("Peer", e.data);
channel.onopen = () => console.log("DataChannel open");

pc.onicecandidate = async e => {
  if (e.candidate) {
    await fetch(`/api/signaling?candidate=${encodeURIComponent(JSON.stringify(e.candidate))}`);
  }
};

pc.ondatachannel = event => {
  channel = event.channel;
  channel.onmessage = e => addMessage("Peer", e.data);
};

async function pollSignaling() {
  const res = await fetch(`/api/signaling`);
  const { offer, answer, candidates } = await res.json();

  if (offer && !pc.currentRemoteDescription) {
    await pc.setRemoteDescription(offer);
    const answerDesc = await pc.createAnswer();
    await pc.setLocalDescription(answerDesc);
    await fetch(`/api/signaling?answer=${encodeURIComponent(JSON.stringify(answerDesc))}`);
  }

  if (answer && pc.signalingState === "have-local-offer" && !pc.currentRemoteDescription) {
    await pc.setRemoteDescription(answer);
  }

  if (candidates) {
    for (let c of candidates) {
      try { await pc.addIceCandidate(c); } catch {}
    }
  }

  setTimeout(pollSignaling, 1000); // poll every second
}

async function start() {
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  await fetch(`/api/signaling?offer=${encodeURIComponent(JSON.stringify(offer))}`);
  pollSignaling();
}

function addMessage(sender, text) {
  const div = document.getElementById("messages");
  div.innerHTML += `<p><strong>${sender}:</strong> ${text}</p>`;
  div.scrollTop = div.scrollHeight;
}

document.getElementById("send").onclick = () => {
  const msg = document.getElementById("input").value;
  if (msg && channel.readyState === "open") {
    channel.send(msg);
    addMessage("You", msg);
    document.getElementById("input").value = "";
  }
};

start();
</script>
</body>
</html>
