<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>P2P Chat</title>
  <style>
    #messages { border: 1px solid #ccc; height: 200px; overflow-y: auto; padding: 5px; }
  </style>
</head>
<body>
  <h1>P2P Chat</h1>
  <div id="messages"></div>
  <input id="input" placeholder="Type a message" />
  <button id="send">Send</button>

<script>
const userId = crypto.randomUUID();
let partnerId = null;
let isInitiator = false;
let pc, channel;

function logMessage(sender, text) {
  const m = document.getElementById('messages');
  m.innerHTML += `<p><strong>${sender}:</strong> ${text}</p>`;
  m.scrollTop = m.scrollHeight;
}

function sendSignal(data) {
  fetch('/api/signaling/signal', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ from: userId, to: partnerId, ...data })
  });
}

// Set up SSE
const evtSource = new EventSource(`/api/signaling?userId=${userId}`);

evtSource.addEventListener('connected', e => {
  console.log('Connected to signaling server', e.data);
  findMatch();
});

evtSource.addEventListener('matched', async e => {
  const { partnerId: pid, isInitiator: init } = JSON.parse(e.data);
  partnerId = pid;
  isInitiator = init;
  console.log(`Matched with ${partnerId}, initiator: ${isInitiator}`);
  await setupPeerConnection();
  if (isInitiator) {
    channel = pc.createDataChannel("chat");
    setupDataChannel(channel);
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    sendSignal({ type: 'offer', offer });
  }
});

evtSource.addEventListener('signal', async e => {
  const { type, offer, answer, candidate } = JSON.parse(e.data);
  if (type === 'offer') {
    await pc.setRemoteDescription(offer);
    const answerDesc = await pc.createAnswer();
    await pc.setLocalDescription(answerDesc);
    sendSignal({ type: 'answer', answer: answerDesc });
  } else if (type === 'answer') {
    await pc.setRemoteDescription(answer);
  } else if (type === 'candidate') {
    try { await pc.addIceCandidate(candidate); } catch (err) { console.error(err); }
  }
});

evtSource.addEventListener('partner-disconnected', () => {
  logMessage('System', 'Partner disconnected.');
});

function findMatch() {
  fetch('/api/signaling/find-match', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ userId })
  });
}

async function setupPeerConnection() {
  pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });

  pc.onicecandidate = e => {
    if (e.candidate) sendSignal({ type: 'candidate', candidate: e.candidate });
  };

  pc.ondatachannel = e => {
    channel = e.channel;
    setupDataChannel(channel);
  };
}

function setupDataChannel(ch) {
  ch.onopen = () => logMessage('System', 'Data channel open');
  ch.onmessage = e => logMessage('Peer', e.data);
}

document.getElementById('send').onclick = () => {
  const text = document.getElementById('input').value;
  if (text && channel?.readyState === 'open') {
    channel.send(text);
    logMessage('You', text);
    document.getElementById('input').value = '';
  }
};
</script>
</body>
</html>
